name: Cherry Backend Deploy (GHCR -> EC2)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  build_push_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set image
        run: |
          echo "IMAGE=ghcr.io/${{ github.repository }}:latest" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE }}
            ghcr.io/${{ github.repository }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy on EC2 (pull & up)
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          INTERNAL_TOKEN: ${{ secrets.INTERNAL_TOKEN }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: DB_HOST,DB_NAME,DB_USERNAME,DB_PASSWORD,JWT_SECRET,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION,INTERNAL_TOKEN
          script: |
            set -e
            cd /home/ec2-user/cherry

            # Create .env file with all configuration
            # Note: Sensitive values are masked in logs by GitHub Actions
            cat > .env << EOF
            DB_HOST=${DB_HOST}
            DB_NAME=${DB_NAME}
            DB_USERNAME=${DB_USERNAME}
            DB_PASSWORD=${DB_PASSWORD}
            SPRING_DATASOURCE_URL=jdbc:mysql://${DB_HOST}:3306/${DB_NAME}?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
            SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
            SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
            JWT_SECRET=${JWT_SECRET}
            AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            AWS_REGION=${AWS_REGION}
            INTERNAL_TOKEN=${INTERNAL_TOKEN}
            STORAGE_BASE_URL=https://cheryi-product-images-prod.s3.ap-northeast-2.amazonaws.com
            EOF
            
            # Secure .env file permissions
            chmod 600 .env
            
            # Pull latest images and restart containers
            docker compose pull || docker-compose pull
            docker compose --env-file .env up -d || docker-compose --env-file .env up -d
            
            # Cleanup old images
            docker image prune -f
            
            echo "Deployment completed. Verifying container status..."
            docker compose ps || docker-compose ps
